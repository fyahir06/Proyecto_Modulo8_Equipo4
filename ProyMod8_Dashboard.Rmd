---
title: "Mercado Laboral y Desempleo"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: journal
    source_code: embed
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(plotly)
library(leaflet)
library(crosstalk)
library(RColorBrewer)
library(ggplot2)
library(kableExtra)
library(htmltools)
library(dplyr)
library(readr)
library(janitor)
library(shiny)
library(plotly)
library(DT)
library(leaflet)
library(rnaturalearth)
library(sf)
library(scales) 

# Cargamos datos de la Población Total 
poblacion_raw <- read_csv("WB_WDI_SP_POP_TOTL.csv")

# Limpiamos la base de datos
poblacion_clean <- poblacion_raw %>%
  clean_names() %>%
  filter(time_period >= 2000) %>%
  select(time_period, ref_area_label, obs_value) %>%
  rename(
    annio = time_period,
    pais = ref_area_label,
    poblacion_total = obs_value
  )


# Cargamos datos de Tasa de desempleo
datos_TD <- read_csv("WB_GS_SL_UEM_ZS.csv")

# Limpiamos la base de datos
datos_TD <- datos_TD %>%
  clean_names() %>%
  distinct() %>%
  filter(time_period >= 2000) %>%
  filter(!is.na(obs_value)) %>%   # Quita registros sin tasa de desempleo
  filter(age_name == "15 years old and over") %>% 
  select(
    time_period, ref_area_id, ref_area_name,
    sex_name, age_name, obs_value, comp_breakdown_1_name
  ) %>%
  rename(
    annio = time_period,
    pais_code = ref_area_id,
    pais = ref_area_name,
    sexo = sex_name,
    tasa_desempleo = obs_value,
    grupo_edad = age_name,
    estimacion = comp_breakdown_1_name
  ) %>%
  mutate(
    annio = as.integer(annio),
    estimacion = str_remove(estimacion, "^Estimate:\\s*")  )

# Cargamos datos de Fuerza laboral / participación
datos_FL <- read_csv("WB_WDI_SL_TLF_CACT_NE_ZS.csv")
# Limpiamos la base de datos
datos_FL <- datos_FL %>%
  clean_names() %>%
  distinct() %>%
  filter(time_period >= 2000) %>%
  filter(!is.na(obs_value)) %>%
  select(
    time_period, ref_area, ref_area_label, sex_label, obs_value
  ) %>%
  rename(
    annio = time_period,
    pais_code = ref_area,
    pais = ref_area_label,
    sexo = sex_label,
    tasa_participacion = obs_value
  ) %>%
  mutate(
    annio = as.integer(annio) )

# 3) Unión de bases (
datos_union <- datos_FL %>%
  mutate(
    grupo_edad = "15 years old and over",
    estimacion = "National"
  ) %>%
  inner_join(
    datos_TD,
    by = c("annio", "pais", "sexo", "grupo_edad", "estimacion", "pais_code")
  )

#Se realizó la limpieza de datos estandarizando nombres de variables, se aliminaron registros duplicados, exclusión de observaciones con valores faltantes en variables clave y se homologaron categorías para permitir la integración de bases de datos. Para despoués poder unir las bases mediante datos en comun como país, año, sexo y grupo de edad.

# shapefile mundial
world <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")

```

```{r, include=FALSE}
#Base de datos de población total.
#Esta base contiene información sobre la cantidad de habitantes que tiene cada país y región en distintos años. Sirve para conocer cómo ha cambiado el tamaño de la población con el paso del tiempo y usar este dato como referencia en otros análisis.

#Base de datos de tasa de desempleo.
#Esta base incluye el porcentaje de personas desempleadas en cada país y año, con datos separados por sexo y grupos de edad. Permite ver cómo ha cambiado el desempleo a lo largo del tiempo y comparar la situación entre distintos países.

#Base de datos de tasa de participación en la fuerza laboral.
#Esta base muestra el porcentaje de personas que participan en el mercado laboral en cada país y año. Ayuda a entender qué tanta gente está trabajando o buscando trabajo y cómo varía este comportamiento entre países y períodos.
```

```{r, include=FALSE}
tags$head(
tags$style(HTML("
.card-plot {
background-color: #ffffff;
border-radius: 10px;
box-shadow: 0 2px 10px rgba(0,0,0,0.08);
padding: 15px;
margin-bottom: 20px;
}
"))
)
```



Tasa de Desempleo
========
Column {.sidebar}
----------------------------------------------------------------------

### Guía rápida

Conjunto de datos del Banco Mundial con información sobre la tasa de desempleo por país y año.


**Fuente de datos**: Indicador de tasa de desempleo (% de la fuerza laboral), Banco Mundial.

**Variables principales**:

- `pais`: nombre del país o región.
- `annio`: año de referencia.
- `sexo`: categoría de sexo (`Female`, `Male`, `Total`).
- `grupo_edad`: grupo de edad (por ejemplo, `15 years old and over`).
- `estimacion`: tipo de estimación (`National`, `Modeled`).
- `tasa_desempleo`: tasa de desempleo en porcentaje (%).
  
  
**Descripción de la visualización:**

En esta sección se muestra el registro histórico de la tasa de desempleo de los paises seleccionados y además, tenemos un gráfico de barras que compara la tasa de desempleo entre hombres y mujeres, permitiendo explorar los cambios a lo largo del tiempo mediante una animación por año.

Column {data-width=180}
-------------------------------------------------------------------

```{r}
wellPanel(
  selectInput(
    "pais_g", "País:",
    choices  = sort(unique(datos_TD$pais)),
    selected = head(sort(unique(datos_TD$pais)), 3),
    multiple = TRUE
  ),
  selectInput(
    "sexo_g", "Sexo:",
    choices  = sort(unique(datos_TD$sexo)),
    selected = "Total"
  ),
  selectInput(
    "grupo_edad_g", "Grupo de edad:",
    choices  = sort(unique(datos_TD$grupo_edad)),
    selected = "15 years old and over"
  ),
  selectInput(
    "estimacion_g", "Estimación:",
    choices  = sort(unique(datos_TD$estimacion)),
    selected = "National"
  )
)

```

row
-----
```{r, include=FALSE}
datos_filtrados_g <- reactive({
req(input$pais_g, input$sexo_g, input$grupo_edad_g, input$estimacion_g)
datos_TD %>%
filter(
pais %in% input$pais_g,
sexo == input$sexo_g,
grupo_edad == input$grupo_edad_g,
estimacion == input$estimacion_g
) %>%
arrange(annio)
})
```

###
```{r}
renderPlotly({
  df <- datos_filtrados_g()

  plot_ly(
    df,
    x = ~annio,
    y = ~tasa_desempleo,
    color = ~pais,
    type = "scatter",
    mode = "lines+markers"
  ) %>%
    layout(
      font = list(family = "Georgia", color = "#333333"),
      title = list(text = "Tasa de Desempleo por País")
    )
})


```

###
```{r scatter_code}

renderPlotly({
  req(input$pais_g, input$grupo_edad_g, input$estimacion_g)

  df_barra <- datos_TD %>%
    filter(
      pais       %in% input$pais_g,
      sexo       %in% c("Male", "Female"),
      grupo_edad == input$grupo_edad_g,
      estimacion == input$estimacion_g
    )

  plot_ly(
    df_barra,
    x     = ~pais,
    y     = ~tasa_desempleo,
    color = ~sexo,
    frame = ~annio,
    type  = "bar",
    text  = ~paste0(round(tasa_desempleo, 1), "%"),
    textposition = "outside",
    colors = c("Male" = "#A7C7E7", "Female" = "#F6C1D1")
  ) %>%
    layout(
      font = list(family = "Georgia", color = "#333333"),
      title = list(text = "Comparación por Género de la Tasa de Desempleo"),
      barmode = "group",
      uniformtext = list(minsize = 10, mode = "show")
    ) %>%
    animation_slider(currentvalue = list(prefix = "Año: ")) %>%
    animation_button(visible = FALSE)
})

```

Mapa interactivo
========
Column {.sidebar}
----------------------------------------------------------------------

### Guía rápida

Conjunto de datos del Banco Mundial con información sobre la **tasa de desempleo** por país y año, complementado con datos geográficos de un shapefile mundial para representar los países en un mapa.

**Fuente de datos**: Indicadores del Banco Mundial sobre desempleo (% de la fuerza laboral) y participación en la fuerza laboral.

**Variables principales**:

- `pais`: nombre del país o región.  
- `annio`: año de referencia.  
- `tasa_desempleo`: tasa de desempleo en porcentaje (%).  
- `tasa_participacion`: tasa de participación laboral en porcentaje (%).  

**Descripción de la visualización:**

En esta sección se muestra un **mapa interactivo** de la tasa de desempleo.  
El usuario puede:

- Seleccionar el **año** con el control deslizante (*Año (mapa)*).  
- Filtrar por **continente** con el menú desplegable (*Continente*).  

Los colores de los países representan el nivel de desempleo (de menor a mayor tasa).  
Al pasar el cursor sobre un país se muestra el nombre y el porcentaje de desempleo, y al hacer clic aparece:

- Continente.  
- Ranking mundial de desempleo.  
- Tasa de desempleo.  
- Tasa de participación laboral.  
- Población total estimada.

Esta visualización permite comparar rápidamente el desempleo entre países y regiones para un año específico.


Row
---------
####
```{r}
wellPanel(
  sliderInput(
    "annio_mapa", "Año (mapa):",
    min   = min(datos_union$annio, na.rm = TRUE),
    max   = max(datos_union$annio, na.rm = TRUE),
    value = max(datos_union$annio, na.rm = TRUE),
    step  = 1
  )
)
```



```{r mapa_desempleo}
renderLeaflet({
  req(input$annio_mapa)

  # Datos por país para el año seleccionado, sexo fijo = "Total"
  df <- datos_union %>%
    filter(
      annio == input$annio_mapa,
      sexo  == "Total"
    ) %>%
    group_by(pais_code, pais) %>%
    summarise(
      tasa_desempleo     = mean(tasa_desempleo,     na.rm = TRUE),
      tasa_participacion = mean(tasa_participacion, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    arrange(desc(tasa_desempleo)) %>%
    mutate(
      ranking_mundial = min_rank(desc(tasa_desempleo))
    )

  # Unimos con shapefile mundial
  mapa <- world %>%
    left_join(df, by = c("iso_a3" = "pais_code"))


  # Validación
  if (all(is.na(mapa$tasa_desempleo))) {
    validate(
      need(FALSE,
           "No hay datos de tasa de desempleo disponibles para dibujar el mapa con estos filtros.")
    )
  }

  pal <- colorNumeric(
    palette  = "YlOrRd",
    domain   = mapa$tasa_desempleo,
    na.color = "gray"
  )

  leaflet(mapa) %>%
    addTiles() %>%
    addPolygons(
      fillColor   = ~pal(tasa_desempleo),
      weight      = 0.6,
      color       = "white",
      fillOpacity = 0.85,

      label = ~paste0(name_long, ": ",
                      round(tasa_desempleo, 1), "% desempleo"),
      labelOptions = labelOptions(
        direction = "auto",
        textsize  = "11px"
      ),

      # Resaltado al pasar el mouse
      highlightOptions = highlightOptions(
        weight      = 2,
        color       = "#444444",
        fillOpacity = 0.9,
        bringToFront = TRUE
      ),

      # click
      popup = ~paste0(
        "<b>", name_long, "</b><br>",
        "Continente: ", continent, "<br>",
        "Ranking mundial (desempleo): ", ranking_mundial, "<br>",
        "Tasa de desempleo: ", round(tasa_desempleo, 2), "%<br>",
        "Tasa de participación laboral: ", round(tasa_participacion, 2), "%<br>",
        "Población total estimada: ",
          ifelse(!is.na(pop_est),
                 scales::comma(pop_est, accuracy = 1),
                 "No disponible")
      )
    ) %>%
    addLegend(
      pal      = pal,
      values   = ~tasa_desempleo,
      opacity  = 0.9,
      title    = "Tasa de desempleo (%)",
      position = "bottomright"
    )
})

```



### Población mundial 

```{r kpi_poblacion}
renderValueBox({

  # Juntamos datos de desempleo con población del shapefile
  df <- datos_union %>%
    filter(
      annio == input$annio_mapa,
      sexo  == "Total"
    ) %>%
    left_join(
      world %>% st_drop_geometry() %>% select(iso_a3, pop_est),
      by = c("pais_code" = "iso_a3")
    )

  poblacion_mundial <- sum(df$pop_est, na.rm = TRUE)

  valueBox(
    value   = scales::comma(round(poblacion_mundial, 0)),
    caption = "Población mundial estimada",
    icon    = "fa-users",
    color   = "#FFCDD2"  
  )
})
```

### Tasa de desempleo mundial 
```{r}
renderValueBox({

  df <- datos_union %>%
    filter(
      annio == input$annio_mapa,
      sexo  == "Total"
    ) %>%
    left_join(
      world %>% st_drop_geometry() %>% select(iso_a3, pop_est),
      by = c("pais_code" = "iso_a3")
    ) %>%
    # Quitar países sin dato de tasa o población
    filter(!is.na(tasa_desempleo),
           !is.na(pop_est))

  tasa_mundial_desemp <- weighted.mean(df$tasa_desempleo, df$pop_est, na.rm = TRUE)

  valueBox(
    value   = paste0(round(tasa_mundial_desemp, 1), " %"),
    caption = "Tasa de desempleo mundial",
    icon    = "fa-line-chart",
    color   = "#D6D6D6"
  )
})

```

### Tasa de participación mundial 
```{r}
renderValueBox({

  df <- datos_union %>%
    filter(
      annio == input$annio_mapa,
      sexo  == "Total"
    ) %>%
    left_join(
      world %>% st_drop_geometry() %>% select(iso_a3, pop_est),
      by = c("pais_code" = "iso_a3")
    ) %>%
    # Quitar países sin dato de tasa o población
    filter(!is.na(tasa_participacion),
           !is.na(pop_est))

  tasa_mundial_part <- weighted.mean(df$tasa_participacion, df$pop_est, na.rm = TRUE)

  valueBox(
    value   = paste0(round(tasa_mundial_part, 1), " %"),
    caption = "Tasa de participación laboral mundial",
    icon    = "fa-briefcase",
    color   = "#424242"
  )
})

```


